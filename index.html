<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ğŸ”¹ 1. Thay cáº¥u hÃ¬nh nÃ y báº±ng project cá»§a báº¡n
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  // ğŸ”¹ 2. Khá»Ÿi táº¡o Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  const db = getFirestore(app);

  // Biáº¿n toÃ n cá»¥c
  let currentUser = JSON.parse(localStorage.getItem("currentUser")) || null;
  let cart = [];

  // ğŸ”¹ 3. ÄÄƒng nháº­p Google
  async function loginWithGoogle() {
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;

      currentUser = {
        name: user.displayName,
        email: user.email,
        photo: user.photoURL
      };
      localStorage.setItem("currentUser", JSON.stringify(currentUser));

      // Tá»± táº¡o user document náº¿u chÆ°a cÃ³
      const userRef = doc(db, "users", currentUser.email);
      const docSnap = await getDoc(userRef);
      if (!docSnap.exists()) {
        await setDoc(userRef, {
          name: currentUser.name,
          email: currentUser.email,
          cart: [],
          orders: []
        });
        console.log("âœ… ÄÃ£ táº¡o tÃ i khoáº£n má»›i trong Firestore!");
      }

      // Láº¥y giá» hÃ ng Firestore
      const data = (await getDoc(userRef)).data();
      cart = data.cart || [];
      updateCartDisplay();

      alert(`ChÃ o má»«ng ${currentUser.name}!`);
    } catch (error) {
      console.error("Lá»—i Ä‘Äƒng nháº­p:", error);
      alert("ÄÄƒng nháº­p tháº¥t báº¡i: " + error.message);
    }
  }

  // ğŸ”¹ 4. LÆ°u giá» hÃ ng lÃªn Firestore
  async function saveCart() {
    if (!currentUser) return;
    const userRef = doc(db, "users", currentUser.email);
    await updateDoc(userRef, { cart });
    console.log("ğŸ”„ Giá» hÃ ng Ä‘Ã£ lÆ°u lÃªn Firestore");
  }

  // ğŸ”¹ 5. Khi Ä‘áº·t hÃ ng
  async function confirmOrder() {
    if (!currentUser || cart.length === 0) {
      alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p hoáº·c giá» hÃ ng trá»‘ng!");
      return;
    }

    const order = {
      date: new Date().toLocaleString("vi-VN"),
      items: cart,
      total: cart.reduce((sum, item) => sum + item.price * item.quantity, 0)
    };

    const userRef = doc(db, "users", currentUser.email);
    await updateDoc(userRef, {
      orders: arrayUnion(order),
      cart: []
    });

    cart = [];
    updateCartDisplay();
    alert("âœ… Äáº·t hÃ ng thÃ nh cÃ´ng!");
  }

  // ğŸ”¹ 6. Khi táº£i láº¡i trang â†’ khÃ´i phá»¥c giá» hÃ ng
  window.addEventListener("load", async () => {
    if (currentUser) {
      const userRef = doc(db, "users", currentUser.email);
      const docSnap = await getDoc(userRef);
      if (docSnap.exists()) {
        cart = docSnap.data().cart || [];
        updateCartDisplay();
      }
    }
  });

  // ğŸ”¹ 7. ÄÄƒng xuáº¥t
  async function logout() {
    await signOut(auth);
    localStorage.removeItem("currentUser");
    cart = [];
    updateCartDisplay();
    alert("Báº¡n Ä‘Ã£ Ä‘Äƒng xuáº¥t.");
  }

  // ğŸ”¹ 8. Giáº£ sá»­ báº¡n Ä‘Ã£ cÃ³ hÃ m nÃ y Ä‘á»ƒ cáº­p nháº­t giao diá»‡n giá» hÃ ng
  function updateCartDisplay() {
    console.log("ğŸ›’ Giá» hÃ ng hiá»‡n táº¡i:", cart);
    // (ThÃªm code hiá»ƒn thá»‹ lÃªn giao diá»‡n cá»§a báº¡n)
  }

  // Xuáº¥t hÃ m ra global náº¿u cáº§n gá»i tá»« HTML
  window.loginWithGoogle = loginWithGoogle;
  window.confirmOrder = confirmOrder;
  window.logout = logout;
</script>
