<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // 🔹 1. Thay cấu hình này bằng project của bạn
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  // 🔹 2. Khởi tạo Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  const db = getFirestore(app);

  // Biến toàn cục
  let currentUser = JSON.parse(localStorage.getItem("currentUser")) || null;
  let cart = [];

  // 🔹 3. Đăng nhập Google
  async function loginWithGoogle() {
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;

      currentUser = {
        name: user.displayName,
        email: user.email,
        photo: user.photoURL
      };
      localStorage.setItem("currentUser", JSON.stringify(currentUser));

      // Tự tạo user document nếu chưa có
      const userRef = doc(db, "users", currentUser.email);
      const docSnap = await getDoc(userRef);
      if (!docSnap.exists()) {
        await setDoc(userRef, {
          name: currentUser.name,
          email: currentUser.email,
          cart: [],
          orders: []
        });
        console.log("✅ Đã tạo tài khoản mới trong Firestore!");
      }

      // Lấy giỏ hàng Firestore
      const data = (await getDoc(userRef)).data();
      cart = data.cart || [];
      updateCartDisplay();

      alert(`Chào mừng ${currentUser.name}!`);
    } catch (error) {
      console.error("Lỗi đăng nhập:", error);
      alert("Đăng nhập thất bại: " + error.message);
    }
  }

  // 🔹 4. Lưu giỏ hàng lên Firestore
  async function saveCart() {
    if (!currentUser) return;
    const userRef = doc(db, "users", currentUser.email);
    await updateDoc(userRef, { cart });
    console.log("🔄 Giỏ hàng đã lưu lên Firestore");
  }

  // 🔹 5. Khi đặt hàng
  async function confirmOrder() {
    if (!currentUser || cart.length === 0) {
      alert("Bạn chưa đăng nhập hoặc giỏ hàng trống!");
      return;
    }

    const order = {
      date: new Date().toLocaleString("vi-VN"),
      items: cart,
      total: cart.reduce((sum, item) => sum + item.price * item.quantity, 0)
    };

    const userRef = doc(db, "users", currentUser.email);
    await updateDoc(userRef, {
      orders: arrayUnion(order),
      cart: []
    });

    cart = [];
    updateCartDisplay();
    alert("✅ Đặt hàng thành công!");
  }

  // 🔹 6. Khi tải lại trang → khôi phục giỏ hàng
  window.addEventListener("load", async () => {
    if (currentUser) {
      const userRef = doc(db, "users", currentUser.email);
      const docSnap = await getDoc(userRef);
      if (docSnap.exists()) {
        cart = docSnap.data().cart || [];
        updateCartDisplay();
      }
    }
  });

  // 🔹 7. Đăng xuất
  async function logout() {
    await signOut(auth);
    localStorage.removeItem("currentUser");
    cart = [];
    updateCartDisplay();
    alert("Bạn đã đăng xuất.");
  }

  // 🔹 8. Giả sử bạn đã có hàm này để cập nhật giao diện giỏ hàng
  function updateCartDisplay() {
    console.log("🛒 Giỏ hàng hiện tại:", cart);
    // (Thêm code hiển thị lên giao diện của bạn)
  }

  // Xuất hàm ra global nếu cần gọi từ HTML
  window.loginWithGoogle = loginWithGoogle;
  window.confirmOrder = confirmOrder;
  window.logout = logout;
</script>
